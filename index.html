<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Formación CAB</title>
  <script>
(function guard(){
const MAX_AGE = 24 * 60 * 60 * 300; // 24h
try{
const s = JSON.parse(localStorage.getItem('cab_auth') || 'null');
const valid = s && (Date.now() - s.ts) < MAX_AGE;
if(!valid){
localStorage.removeItem('cab_auth');
const here = location.pathname.split('/').pop() || 'index.html';
location.replace('login.html?next=' + encodeURIComponent(here + location.search));
}
}catch{
location.replace('login.html?next=' + encodeURIComponent('index.html'));
}
})();
</script>
<style>
#logout-container { width: 100%; display: flex; justify-content: flex-end; padding: 10px 20px 0 0; box-sizing: border-box; }
#logout-btn { background-color: #dc2626; color: white; font-weight: 600; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; transition: background 0.2s ease; }
#logout-btn:hover { background-color: #b91c1c; }
</style>
  <style>
    body{
      font-family: Arial, sans-serif;
      background: #e9ecef url('AFA.jpg') center/cover no-repeat fixed;
      margin:0; padding:10px;
      display:flex; flex-direction:column; align-items:center;
    }
    #field{
      position:relative;
      background: url('1137.jpg') center/cover no-repeat;
      width:360px; height:540px;
      border:3px solid #fff; border-radius:10px;
      margin:10px 0; page-break-inside: avoid;
      box-shadow: 0 12px 28px rgba(0,0,0,.18);
    }
    .player-container{
      position:absolute;
      display:flex; flex-direction:column; align-items:center;
      width:60px; cursor:move;
    }
    .player{ width:60px; height:70px; background:url('camiseta.png') center/contain no-repeat; display:flex; align-items:flex-end; justify-content:center; }
    .player-number{ font-weight:bold; color:black; font-size:14px; margin-bottom:30px; }
    .player-name{ font-size:10px; font-weight:bold; color:black; background:rgba(255,255,255,0.7); padding:1px 6px; border-radius:999px; margin-top:4px; text-align:center; max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    #bench{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:10px; background: rgba(255,255,255,0.9); border: 1px dashed #666; border-radius: 8px; padding: 10px; width: 450px; box-shadow: inset 0 0 0 1px #e5e7eb; }
    #bench .player-container{ position:relative !important; left:0 !important; top:0 !important; cursor:default; }

    button, input, select{ margin:5px; padding:6px 10px; font-size:14px; }
    .panel{ background:#f8fafc; border-radius:12px; padding:12px; border:1px solid #e5e7eb; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .titulo-select{ font-size: 24px; font-weight: 700; border: none; background: transparent; text-align: center; display:block; margin: auto; }
    .is-invalid{ border-color:#ef4444 !important; box-shadow:0 0 0 2px rgba(239,68,68,.15); }
    .help-text{ font-size:12px; color:#ef4444; margin-left:6px; }

    @media print{
      body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; background: url('AFA.jpg') center/cover no-repeat !important; }
      #field{ background: url('1137.jpg') center/cover no-repeat !important; }
      .player{ background: url('camiseta.png') center/contain no-repeat !important; }
      form, button, #loadFile, .event-form, #excelInput, .titulo-select, #excelBlock, #excelBlock *{ display:none !important; }
      #printTitle{ font-size: 24px; font-weight: 700; border: none; background: transparent; text-align: center; margin: auto; display:block !important; }
      #eventData { display: block !important; text-align: center; margin: 0 auto 0px auto; font-size: 16px; line-height: 1.5; white-space: pre-line; width: 90%; }
      .player-container{ page-break-inside: avoid; }
      .panel{ border:0; background:#fff; }
      .delete-x { display: none !important; }
      #bench{ display:flex !important; }
    }

    #logout-container { width: 100%; display: flex; justify-content: flex-end; padding: 10px 20px 0 0; box-sizing: border-box; }
    #logout-btn { background-color: #dc2626; color: white; font-weight: 600; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; transition: background 0.2s ease; }
    #logout-btn:hover { background-color: #b91c1c; }

    .delete-x{ position:absolute; top:-6px; right:-6px; width:20px; height:20px; line-height:20px; text-align:center; color:#fff; background:#ef4444; border-radius:999px; font-weight:700; font-size:14px; cursor:pointer; user-select:none; z-index:10; box-shadow:0 1px 3px rgba(0,0,0,.3); display:none; }
    .player-container:hover .delete-x{ display:block; }

    #excelBlock{ display:block; }
  </style>
</head>
<body>
<header style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;">
  <img src="logo.png" alt="Logo Club Atlético Belgrano" style="width: 80px; height: 80px;">
</header>

  <div id="logout-container"><button id="logout-btn" onclick="logout()">Cerrar sesión</button></div>

  <div style="margin:6px 0 4px;">
    <select id="tituloFormacion" class="titulo-select">
      <option value="FORMACION JUVENILES LPF" selected>FORMACION JUVENILES LPF</option>
      <option value="FORMACION JUVENILES LCF">FORMACION JUVENILES LCF</option>
      <option value="FORMACION FEMENINO">FORMACION FEMENINO</option>
    </select>
  </div>
  <div id="printTitle"></div>
  <div id="eventData"></div>

  <!-- Evento -->
  <div class="event-form panel" style="max-width:980px;">
    <div class="row">
      <select id="categoriaSelect">
        <option value="">Seleccione Categoría</option>
        <option value="Reserva">Reserva</option>
        <option value="Cuarta">Cuarta</option>
        <option value="Quinta">Quinta</option>
        <option value="Sexta">Sexta</option>
        <option value="Septima">Séptima</option>
        <option value="Octava">Octava</option>
        <option value="Novena">Novena</option>
      </select>

      <select id="NFecha">
        <option value="">Seleccione N° Fecha</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
        <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
        <option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option>
        <option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option>
      </select>

      <input type="date" id="fechaEncuentro">
      <input type="time" id="horaEncuentro">

      <select id="rivalSelect">
        <option value="">Seleccione Rival</option>
        <option value="River Plate">River Plate</option>
        <option value="Boca Juniors">Boca Juniors</option>
        <option value="Racing Club">Racing Club</option>
        <option value="San Lorenzo">San Lorenzo</option>
        <option value="Independiente">Independiente</option>
      </select>
    </div>

    <div class="row" style="margin-top:6px;">
      <label><input type="radio" name="condicion" id="condLocal" value="Local" checked /> Local</label>
      <label><input type="radio" name="condicion" id="condVisitante" value="Visitante" /> Visitante</label>
    </div>

    <div id="predioLocalWrap" class="row" style="margin-top:6px;">
      <select id="predioLocal">
        <option value="">Seleccione Predio (Local)</option>
        <option value="Julio César Villagra">Julio César Villagra</option>
        <option value="Predio Armando Pérez">Predio Armando Pérez</option>
      </select>
    </div>

    <div id="predioVisitanteWrap" class="row" style="display:none; margin-top:6px;">
      <input type="text" id="predioVisitante" placeholder="Predio / Cancha del rival" />
    </div>

    <button type="button" id="guardarEvento">Guardar Evento</button>
  </div>

  <!-- Formulario jugadores -->
  <form id="playerForm" class="panel" style="max-width:980px; margin-top:10px;">
    <h3>Formación del Partido</h3>

    <div id="excelBlock" style="margin-top:12px;">
      <hr />
      <h3>Listado de jugadores (Excel)</h3>
      <div class="row">
        <input type="file" id="excelInput" accept=".xlsx,.xls" />
      </div>
      <div id="excelStatus" style="font-size:13px; opacity:.8;"></div>
    </div>

    <div class="row">
      <input list="playerNames" id="name" placeholder="Nombre" required />
      <datalist id="playerNames"></datalist>
      <div style="display:flex; flex-direction:column;">
        <input type="number" id="number" placeholder="N°" required />
        <small id="numHelp" class="help-text" style="display:none;">Número repetido</small>
      </div>
      <select id="position">
        <option value="titular">Titular</option>
        <option value="suplente">Suplente</option>
      </select>
      <button type="submit">Agregar</button>
    </div>

    <div class="row">
      <select id="formationSelect">
        <option value="4-4-2">4-4-2</option>
        <option value="4-4-1-1">4-4-1-1</option>
        <option value="4-3-1-2">4-3-1-2</option>
        <option value="4-1-3-2">4-1-3-2</option>
        <option value="4-3-3">4-3-3</option>
        <option value="4-1-4-1">4-1-4-1</option>
        <option value="4-2-3-1">4-2-3-1</option>
        <option value="3-4-1-2">3-4-1-2</option>
        <option value="3-4-3">3-4-3</option>
        <option value="3-5-2">3-5-2</option>
        <option value="5-3-2">5-3-2</option>
      </select>
      <button type="button" onclick="applyFormation()">Aplicar Formación</button>
    </div>

    <div class="row">
      <button type="button" onclick="saveFormation()">Guardar</button>
      <button type="button" onclick="loadFormation()">Cargar JSON</button>
      <button type="button" onclick="exportPDF()">Exportar a PDF</button>
      <button type="button" onclick="sendWhatsApp()">WhatsApp</button>
      <button type="button" onclick="goToReporte()">Planilla post-partido</button>
      <input type="file" id="loadFile" style="display:none" />
    </div>
  </form>

  <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
    <div id="field"></div>
    <div class="panel" style="min-width:180px;">
      <h3 class="ct-header">Cuerpo Técnico</h3>
      <div id="cuerpoTecnicoValores" style="margin-top:8px; font-size:14px; line-height:1.6;">
        <p><strong>DT:</strong> <span id="dt">—</span></p>
        <p><strong>AC:</strong> <span id="ac">—</span></p>
        <p><strong>PF:</strong> <span id="pf">—</span></p>
      </div>
      <hr class="no-print-on-pdf" style="border:none; border-top:1px solid #e5e7eb; margin:10px 0" />
    </div>
  </div>

  <h3>Suplentes</h3>
  <div id="bench"></div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let eventInfo = { categoria:"", nFecha:"", fecha:"", hora:"", rival:"", formacion:"", condicion:"", predio:"" };
    let players = [];

    const $ = sel => document.querySelector(sel);
    function saveState(){
      try{
        localStorage.setItem('cab_eventInfo', JSON.stringify(eventInfo||{}));
        localStorage.setItem('cab_players', JSON.stringify(players||[]));
      }catch(e){}
    }
    function loadState(){
      try{
        const e = JSON.parse(localStorage.getItem('cab_eventInfo')||'null');
        const p = JSON.parse(localStorage.getItem('cab_players')||'null');
        if(e) eventInfo = Object.assign(eventInfo, e);
        if(p && Array.isArray(p)) players = p;
      }catch{}
    }

    const tituloSelect = document.getElementById("tituloFormacion");
    const printTitle  = document.getElementById("printTitle");
    function syncPrintTitle(){ printTitle.textContent = (tituloSelect.value || "").toUpperCase(); }
    tituloSelect.addEventListener("change", ()=>{ syncPrintTitle(); pintarResumen(); saveState(); });

    const cuerpoTecnicoPorCategoria = {
      reserva: { dt: "Norberto Fernández", ac: "Leonardo Felicia", pf: "Dino Mazzaforte" },
      cuarta:  { dt: "Leandro Zulueta",    ac: "Gabriel Humeniuk", pf: "Alejandro Sabattini" },
      quinta:  { dt: "Julio Lopéz",        ac: "Lautaro Olivera", pf: "Cristian Monteverde" },
      sexta:   { dt: "Daniel Mercado",     ac: "Franco Amaya",    pf: "Roberto Miranda" },
      septima: { dt: "Leonardo Torres",    ac: "Juan Quiroga",    pf: "Ayrton Lewandoski" },
      octava:  { dt: "Lucas Sosa",         ac: "Kevin Constantín",pf: "Lucas Nieva" },
      novena:  { dt: "Lucas Rico",         ac: "Américo Ozán",    pf: "Adrián Peralta" },
    };
    function actualizarCuerpoTecnico(cat){
      const key=(cat||"").toLowerCase();
      const t=cuerpoTecnicoPorCategoria[key];
      document.getElementById("dt").textContent=t?t.dt:"—";
      document.getElementById("ac").textContent=t?t.ac:"—";
      document.getElementById("pf").textContent=t?t.pf:"—";
    }

    const condLocal=$('#condLocal');
    const condVisitante=$('#condVisitante');
    const predioLocalWrap=$('#predioLocalWrap');
    const predioVisitanteWrap=$('#predioVisitanteWrap');
    function actualizarVisibilidadPredio(){
      if(condLocal.checked){ predioLocalWrap.style.display='block'; predioVisitanteWrap.style.display='none'; eventInfo.condicion="Local"; eventInfo.predio = $('#predioLocal').value||eventInfo.predio; }
      else { predioLocalWrap.style.display='none'; predioVisitanteWrap.style.display='block'; eventInfo.condicion="Visitante"; eventInfo.predio = $('#predioVisitante').value.trim()||eventInfo.predio; }
      pintarResumen(); saveState();
    }
    condLocal.addEventListener("change",actualizarVisibilidadPredio);
    condVisitante.addEventListener("change",actualizarVisibilidadPredio);

    document.getElementById("guardarEvento").addEventListener("click",function(){
      const categoria=$('#categoriaSelect').value||"";
      const NFecha=$('#NFecha').value||"";
      const rival=$('#rivalSelect').value||"";
      const fechaRaw=$('#fechaEncuentro').value||"";
      const hora=$('#horaEncuentro').value||"";
      const formacion=$('#formationSelect').value||"";
      const condicion=document.querySelector('input[name="condicion"]:checked')?.value||"Local";
      let predio="";
      if(condicion==="Local"){ predio=$('#predioLocal').value||""; if(!predio){alert("Seleccioná el predio (Local)."); return;} }
      else { predio=$('#predioVisitante').value.trim(); if(!predio){alert("Ingresá el predio del rival."); return;} }
      let fecha=""; if(fechaRaw){const [y,m,d]=fechaRaw.split("-"); fecha=`${d}/${m}/${y}`;}
      actualizarCuerpoTecnico(categoria);
      eventInfo={categoria,nFecha:NFecha,fecha,hora,rival,formacion,condicion,predio};
      pintarResumen(); saveState();
    });

    function pintarResumen(){
      const cont = document.getElementById("eventData");
      cont.innerHTML = `
        <div style="display:flex; flex-wrap:wrap; gap:12px; margin-top:10px;">
          <div><strong>Fecha N°:</strong> ${eventInfo.nFecha||"—"}</div>
          <div><strong>Día:</strong> ${eventInfo.fecha||"—"}</div>
          <div><strong>Hora:</strong> ${eventInfo.hora||"—"}</div>
          <div><strong>Condición:</strong> ${eventInfo.condicion||"—"}</div>
          <div><strong>Predio:</strong> ${eventInfo.predio||"—"}</div>
          <div><strong>Categoría:</strong> ${eventInfo.categoria||"—"}</div>
          <div><strong>Rival:</strong> ${eventInfo.rival||"—"}</div>
          <div><strong>Formación:</strong> ${eventInfo.formacion||"—"}</div>
        </div>`;
    }

    ['#categoriaSelect','#NFecha','#fechaEncuentro','#horaEncuentro','#rivalSelect','#predioLocal','#predioVisitante','#formationSelect'].forEach(sel=>{
      const el = document.querySelector(sel);
      if(!el) return;
      el.addEventListener('change', e=>{
        if(sel==='#categoriaSelect'){ eventInfo.categoria = e.target.value; actualizarCuerpoTecnico(eventInfo.categoria); }
        if(sel==='#NFecha'){ eventInfo.nFecha = e.target.value; }
        if(sel==='#fechaEncuentro'){ const v=e.target.value||""; eventInfo.fecha = v? (([y,m,d]=v.split("-")), `${d}/${m}/${y}`):""; }
        if(sel==='#horaEncuentro'){ eventInfo.hora = e.target.value; }
        if(sel==='#rivalSelect'){ eventInfo.rival = e.target.value; }
        if(sel==='#predioLocal' && eventInfo.condicion==="Local"){ eventInfo.predio = e.target.value; }
        if(sel==='#predioVisitante' && eventInfo.condicion==="Visitante"){ eventInfo.predio = e.target.value.trim(); }
        if(sel==='#formationSelect'){ eventInfo.formacion = e.target.value; }
        pintarResumen(); saveState();
      });
    });

    const field=document.getElementById("field");
    const bench=document.getElementById("bench");
    const form=document.getElementById("playerForm");
    const formationSelect=document.getElementById("formationSelect");
    const loadFile=document.getElementById("loadFile");

    const numberInput = document.getElementById('number');
    const numHelp = document.getElementById('numHelp');
    function isDuplicateNumber(n){ return players.some(p=>String(p.number)===String(n)); }
    numberInput.addEventListener('input', ()=>{
      const val = numberInput.value.trim();
      if(val && isDuplicateNumber(val)){
        numberInput.classList.add('is-invalid');
        numHelp.style.display='block';
      }else{
        numberInput.classList.remove('is-invalid');
        numHelp.style.display='none';
      }
    });

    form.addEventListener("submit",function(e){
      e.preventDefault();
      const name=document.getElementById("name").value.trim();
      const number=document.getElementById("number").value.trim();
      const position=document.getElementById("position").value;
      if(!name||!number) return;
      if(position==="titular" && players.filter(p=>p.position==="titular").length>=11){ alert("Máx 11 titulares"); return; }
      if(position==="suplente" && players.filter(p=>p.position==="suplente").length>=6){ alert("Máx 6 suplentes"); return; }
      if(isDuplicateNumber(number)){ numberInput.classList.add('is-invalid'); numHelp.style.display='block'; return; }
      players.push({name,number,x:0,y:0,position});
      renderPlayers(); form.reset(); numberInput.classList.remove('is-invalid'); numHelp.style.display='none'; saveState();
    });

    function renderPlayers(){
      field.innerHTML=""; bench.innerHTML="";
      players.forEach(player=>{
        const c=document.createElement("div"); c.className="player-container";
        const delX = document.createElement("span"); delX.className = "delete-x"; delX.textContent = "×"; delX.title = "Eliminar jugador"; delX.onmousedown = e=>e.stopPropagation(); delX.onclick = (e)=>{ e.stopPropagation(); const idx=players.indexOf(player); if(idx!==-1) players.splice(idx,1); renderPlayers(); saveState(); };
        c.appendChild(delX);
        const camiseta=document.createElement("div"); camiseta.className="player";
        const num=document.createElement("div"); num.className="player-number"; num.textContent=player.number; camiseta.appendChild(num);
        const name=document.createElement("div"); name.className="player-name"; name.contentEditable=true; name.textContent=player.name; name.addEventListener("input",()=>{ player.name=name.textContent; saveState(); });
        c.appendChild(camiseta); c.appendChild(name);
        if(player.position==="titular"){ c.style.left=player.x+"px"; c.style.top=player.y+"px"; makeDraggable(c,player); field.appendChild(c); }
        else { c.style.position="relative"; c.style.left="0px"; c.style.top="0px"; bench.appendChild(c); }
      });
    }

    function makeDraggable(el,playerData){
      let isDragging=false, offsetX=0, offsetY=0;
      el.addEventListener("mousedown",(e)=>{ isDragging=true; offsetX=e.offsetX; offsetY=e.offsetY; });
      document.addEventListener("mousemove",(e)=>{
        if(!isDragging) return;
        const rect=field.getBoundingClientRect();
        let x=e.clientX-rect.left-offsetX, y=e.clientY-rect.top-offsetY;
        x=Math.max(0,Math.min(x,rect.width-el.offsetWidth));
        y=Math.max(0,Math.min(y,rect.height-el.offsetHeight));
        el.style.left=x+"px"; el.style.top=y+"px";
        playerData.x=x; playerData.y=y;
      });
      document.addEventListener("mouseup",()=>{ if(isDragging){ isDragging=false; saveState(); } });
    }

    function applyFormation(){
      const valores = formationSelect.value.split("-").map(n=>parseInt(n,10)).filter(n=>!isNaN(n));
      const titulares = players.filter(p=>p.position==="titular");
      const total = 1 + valores.reduce((a,b)=>a+b,0);
      if(titulares.length<total){ alert(`Faltan jugadores para ${formationSelect.value} + arquero.`); return; }
      const lines=[{count:1,y:440}];
      const L=valores.length, bottom=360, top=80, step=L>1? (bottom-top)/(L-1):0;
      for(let i=0;i<L;i++){ lines.push({count:valores[i], y: bottom - i*step}); }
      let i=0;
      lines.forEach(line=>{
        const spacing=(360-60)/(line.count+1);
        for(let j=0;j<line.count && i<titulares.length;j++,i++){
          const p=titulares[i]; p.x=spacing*(j+1); p.y=line.y;
        }
      });
      renderPlayers(); saveState();
    }
    window.applyFormation=applyFormation;

    function saveFormation(){ const blob=new Blob([JSON.stringify(players)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="formacion.json"; a.click(); }
    function loadFormation(){ loadFile.click(); }
    loadFile.addEventListener("change",(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ try{ players=JSON.parse(ev.target.result);}catch{players=[];} renderPlayers(); saveState(); }; r.readAsText(f); });
    function resetPositions(){ players.forEach(p=>{ if(p.position==="titular"){ p.x=0; p.y=0; } }); renderPlayers(); saveState(); }
    window.saveFormation=saveFormation; window.loadFormation=loadFormation; window.resetPositions=resetPositions;

    function exportPDF(){ window.print(); }
    window.exportPDF = exportPDF;

    function sendWhatsApp(){
      const titulo = (document.getElementById("tituloFormacion")?.value || "FORMACION JUVENILES LPF").toUpperCase();
      let lines=[]; lines.push(`*${titulo}*`); lines.push("");
      lines.push(`*Fecha N°:* ${eventInfo.nFecha||"—"}`);
      lines.push(`*Día:* ${eventInfo.fecha||"—"}`);
      lines.push(`*Hora:* ${eventInfo.hora||"—"}`);
      lines.push(`*Condición:* ${eventInfo.condicion||"—"}`);
      lines.push(`*Predio:* ${eventInfo.predio||"—"}`);
      lines.push(`*Categoría:* ${eventInfo.categoria||"—"}`);
      lines.push(`*Rival:* ${eventInfo.rival||"—"}`);
      lines.push(`*Formación:* ${eventInfo.formacion||"—"}`);
      lines.push(""); lines.push("*TITULARES:*");
      const titulares=players.filter(p=>p.position==="titular"); if(titulares.length) titulares.forEach(p=>lines.push(`• ${p.number} - ${p.name}`)); else lines.push("—");
      lines.push(""); lines.push("*SUPLENTES:*");
      const suplentes=players.filter(p=>p.position==="suplente"); if(suplentes.length) suplentes.forEach(p=>lines.push(`• ${p.number} - ${p.name}`)); else lines.push("—");
      const dt = (document.getElementById("dt")?.innerText || "").trim(); const ac = (document.getElementById("ac")?.innerText || "").trim(); const pf = (document.getElementById("pf")?.innerText || "").trim();
      if (dt || ac || pf) { lines.push(""); lines.push("*Cuerpo Técnico:*"); if (dt) lines.push(`• DT: ${dt}`); if (ac) lines.push(`• AC: ${ac}`); if (pf) lines.push(`• PF: ${pf}`); }
      const text=lines.join("\n").trim(); window.open("https://wa.me/?text="+encodeURIComponent(text),"_blank");
    }
    window.sendWhatsApp=sendWhatsApp;

    function logout(){ localStorage.removeItem('cab_auth'); location.replace('login.html'); }
    function goToReporte(){ saveState(); location.href = 'reporte.html'; }

    // ===== Excel autocompletar + carga automática a formación =====
    const excelStatus = document.getElementById('excelStatus');
    const datalist    = document.getElementById('playerNames');

    function makeDisplayName(row){
      const posibles = {
        nombre:   row['Nombre'] || row['NOMBRE'] || row['name'] || row['Name'] || row['Nombres'] || row['Jugador'] || row['JUGADOR'] || row['player'] || row['Player'],
        apellido: row['Apellido'] || row['APELLIDO'] || row['lastname'] || row['Last Name'] || row['Apellido/s'] || row['Apellidos']
      };
      if (posibles.nombre && String(posibles.nombre).trim() && posibles.apellido && String(posibles.apellido).trim()) return `${String(posibles.nombre).trim()} ${String(posibles.apellido).trim()}`;
      if (posibles.nombre && String(posibles.nombre).trim()) return String(posibles.nombre).trim();
      for (const k in row) { const v=row[k]; if (v && String(v).trim()) return String(v).trim(); }
      return '';
    }
    function numberFromRow(row){
      const preferidas = ['N°','Nº','Numero','Número','Dorsal','#','Num','Number','N','No'];
      for(const k of preferidas){ if(row[k]!==undefined && String(row[k]).trim()){ const m=String(row[k]).match(/\\d{1,3}/); if(m) return m[0]; } }
      for(const k in row){ const v=String(row[k]||''); const m=v.match(/\\b\\d{1,3}\\b/); if(m) return m[0]; }
      return '';
    }
    function poblarDatalist(nombres){
      datalist.innerHTML = '';
      const unicos = Array.from(new Set(nombres.filter(Boolean)));
      unicos.sort((a,b)=>a.localeCompare(b,'es'));
      unicos.forEach(n => { const opt=document.createElement('option'); opt.value=n; datalist.appendChild(opt); });
      try{ localStorage.setItem('cab_excel_names_cache', JSON.stringify(unicos)); }catch{}
    }
    function headerSafe(h){ return String(h||'').replace(/\\s+/g,' ').trim(); }

    async function parseWorkbook(wb){
      const sheetName = wb.SheetNames.find(n=>{ const s=wb.Sheets[n]; const r=XLSX.utils.sheet_to_json(s, {header:1}); return (r && r.length>0); }) || wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval:'', raw:false, header:1 });
      const headers = (rows[0] || []).map(headerSafe);
      const objs = rows.slice(1).map(r => { const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });

      const nombres = objs.map(row => makeDisplayName(row)).filter(Boolean);
      poblarDatalist(nombres);

      // Auto-cargar jugadores si aún no hay
      if(!players.length){
        const nuevos=[];
        for(const row of objs){
          const name = makeDisplayName(row);
          if(!name) continue;
          let number = numberFromRow(row);
          const dupNum = (arr, n) => n && arr.some(p=>String(p.number)===String(n));
          if(number && (dupNum(nuevos, number) || players.some(p=>String(p.number)===String(number)))) number='';
          const position = nuevos.filter(p=>p.position==='titular').length<11 ? 'titular' : 'suplente';
          if(position==='suplente' && nuevos.filter(p=>p.position==='suplente').length>=6) break;
          nuevos.push({name, number, x:0, y:0, position});
        }
        if(nuevos.length){ players=nuevos; renderPlayers(); saveState(); }
        excelStatus.textContent = `Cargados ${nombres.length} nombres. Añadidos automáticamente ${nuevos.length} jugadores a la formación.`;
      }else{
        excelStatus.textContent = `Cargados ${nombres.length} nombres.`;
      }
    }

    document.getElementById('excelInput').addEventListener('change', async ()=>{
      const file = document.getElementById('excelInput').files?.[0];
      if(!file){ excelStatus.textContent=''; return; }
      excelStatus.textContent = 'Procesando...';
      try{
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type:'array' });
        await parseWorkbook(wb);
      }catch(err){ console.error(err); excelStatus.textContent = 'Error al leer el Excel. Usá .xlsx/.xls con encabezados en la primera fila.'; }
    });

    async function loadExcelByUrl(url){
      try{
        excelStatus.textContent = 'Buscando jugadores.xlsx...';
        const res = await fetch(url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, { type:'array' });
        await parseWorkbook(wb);
      }catch(err){ console.warn(err); excelStatus.textContent = 'No se encontró jugadores.xlsx (opcional). Podés elegir un archivo manualmente.'; }
    }

    function logout(){ localStorage.removeItem('cab_auth'); location.replace('login.html'); }
    function goToReporte(){ saveState(); location.href = 'reporte.html'; }

    function init(){
      loadState();
      document.getElementById('categoriaSelect').value = eventInfo.categoria||'';
      document.getElementById('NFecha').value = eventInfo.nFecha||'';
      if(eventInfo.fecha){ const [d,m,y]=eventInfo.fecha.split('/'); document.getElementById('fechaEncuentro').value = `${y}-${m}-${d}`; }
      document.getElementById('horaEncuentro').value = eventInfo.hora||'';
      document.getElementById('rivalSelect').value = eventInfo.rival||'';
      if((eventInfo.condicion||'local')==='local'){ document.getElementById('condLocal').checked=true; } else { document.getElementById('condVisitante').checked=true; }
      document.getElementById('predioLocal').value = eventInfo.condicion==='local'? (eventInfo.predio||'') : '';
      document.getElementById('predioVisitante').value = eventInfo.condicion==='visitante'? (eventInfo.predio||'') : '';
      actualizarVisibilidadPredio();
      syncPrintTitle();
      actualizarCuerpoTecnico(eventInfo.categoria);
      pintarResumen();
      renderPlayers();
      // Precarga automática si existe jugadores.xlsx
      loadExcelByUrl('jugadores.xlsx');
    }
    init();
  </script>
</body>
</html>
