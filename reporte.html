    <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Planilla Post-Partido — Formación CAB</title>
  <style>
    :root{ color-scheme: light; }
    body{
      font-family: Arial, sans-serif;
      margin:0; padding:16px;
      background:#f5f7fb;
    }
    .container{
      max-width: 1100px;
      margin: 0 auto;
    }
    .toolbar{
      display:flex; gap:8px; align-items:center; justify-content:flex-end;
      margin-bottom:12px;
    }
    .btn{
      border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer;
      background:#2563eb; color:#fff;
    }
    .btn.sec{ background:#334155; }
    .btn.warn{ background:#dc2626; }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .card{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px;
      padding:16px; margin-bottom:16px; box-shadow:0 8px 18px rgba(0,0,0,.06);
    }
    h2{ margin:0 0 10px; font-size:20px; }
    h3{ margin:0 0 8px; font-size:16px; color:#334155; }
    .grid{
      display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{ font-weight:600; font-size:14px; color:#0f172a; }
    input[type="text"], input[type="number"], textarea, select{
      border:1px solid #cbd5e1; border-radius:10px;
      padding:8px 10px; font-size:14px; outline:none; background:#fff;
    }
    input:focus, textarea:focus, select:focus{ border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.12); }
    textarea{ min-height:90px; resize:vertical; }

    /* Tabla */
    .table-wrap{ overflow:auto; }
    table{
      width:100%; border-collapse: collapse; font-size:14px; background:#fff;
    }
    thead th{
      position: sticky; top:0;
      background:#f1f5f9; border-bottom:1px solid #e5e7eb; z-index:1;
      padding:8px; text-align:left; font-weight:700;
    }
    tbody td{
      border-bottom:1px solid #f1f5f9; padding:6px;
    }
    tbody tr:nth-child(odd){ background:#fcfdff; }
    .narrow{ width:70px; }
    .very-narrow{ width:60px; }
    .w-name{ min-width:200px; }
    .center{ text-align:center; }
    .right{ text-align:right; }

    .hint{ font-size:12px; opacity:.75; }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
      .btn{ padding:10px 12px; }
      thead th, tbody td{ font-size:13px; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Barra de acciones -->
    <div class="toolbar">
      <button class="btn sec" id="btnVolver">Volver al inicio</button>
      <button class="btn" id="btnGuardar">Guardar</button>
      <button class="btn" id="btnCSV">Exportar CSV</button>
    </div>

    <!-- Datos del partido -->
    <div class="card" id="partidoCard">
      <h2>Datos del partido</h2>
      <div class="grid">
        <div class="field">
          <label>Categoría</label>
          <input id="p_categoria" type="text" disabled>
        </div>
        <div class="field">
          <label>Rival</label>
          <input id="p_rival" type="text" disabled>
        </div>
        <div class="field">
          <label>Condición</label>
          <input id="p_condicion" type="text" disabled>
        </div>
        <div class="field">
          <label>Predio</label>
          <input id="p_predio" type="text" disabled>
        </div>
        <div class="field">
          <label>Fecha (día)</label>
          <input id="p_fecha" type="text" disabled>
        </div>
        <div class="field">
          <label>Hora</label>
          <input id="p_hora" type="text" disabled>
        </div>
        <div class="field">
          <label>N° Fecha</label>
          <input id="p_nfecha" type="text" disabled>
        </div>
        <div class="field">
          <label>Formación</label>
          <input id="p_formacion" type="text" disabled>
        </div>
      </div>
    </div>

    <!-- Resultado final -->
    <div class="card">
      <h2>Resultado final</h2>
      <div class="grid">
        <div class="field">
          <label id="labCab">CAB</label>
          <input id="res_cab" type="number" min="0" step="1" placeholder="0">
        </div>
        <div class="field">
          <label id="labRival">Rival</label>
          <input id="res_rival" type="number" min="0" step="1" placeholder="0">
        </div>
      </div>
      <div class="hint" style="margin-top:6px;">Completá el resultado final (goles). Podés editar las etiquetas según condición (Local/Visitante).</div>
    </div>

    <!-- Grilla de jugadores y estadísticas -->
    <div class="card">
      <h2>Planilla de jugador por jugador</h2>
      <div class="table-wrap">
        <table id="tabla">
          <thead>
            <tr>
              <th class="very-narrow center">N°</th>
              <th class="w-name">Jugador</th>
              <th>Posición</th>
              <th class="narrow center">Min</th>
              <th class="narrow center">Goles</th>
              <th class="narrow center">Asist</th>
              <th class="narrow center">TA</th>
              <th class="narrow center">TR</th>
              <th class="narrow center">Puntaje</th>
              <th>Comentario</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- se completa con JS -->
          </tbody>
        </table>
      </div>
      <div class="hint" style="margin-top:6px;">Todos los campos son numéricos excepto <strong>Posición</strong> y <strong>Comentario</strong>.</div>
    </div>

    <!-- Otros comentarios -->
    <div class="card">
      <h3>Otros comentarios del partido</h3>
      <textarea id="otrosComentarios" placeholder="Observaciones generales, incidencias, desempeño del equipo..."></textarea>
    </div>

  </div>

  <script>
    // ----- Carga inicial desde localStorage -----
    const eventInfo = JSON.parse(localStorage.getItem('cab_eventInfo') || '{}');
    const players   = JSON.parse(localStorage.getItem('cab_players')   || '[]');

    // Si no hay datos, invitar a volver
    if (!players.length){
      if (confirm("No se encontraron jugadores cargados. ¿Volver a la pantalla principal?")){
        location.href = 'index.html';
      }
    }

    // ----- Etiquetas de resultado en función de la condición -----
    const labCab   = document.getElementById('labCab');
    const labRival = document.getElementById('labRival');
    labCab.textContent   = (eventInfo.condicion === 'visitante') ? (eventInfo.rival || 'Rival') : 'CAB';
    labRival.textContent = (eventInfo.condicion === 'visitante') ? 'CAB' : (eventInfo.rival || 'Rival');

    // ----- Completar cabecera de partido -----
    const byId = id => document.getElementById(id);
    byId('p_categoria').value = eventInfo.categoria || '';
    byId('p_rival').value     = eventInfo.rival || '';
    byId('p_condicion').value = eventInfo.condicion || '';
    byId('p_predio').value    = eventInfo.predio || '';
    byId('p_fecha').value     = eventInfo.fecha || '';
    byId('p_hora').value      = eventInfo.hora || '';
    byId('p_nfecha').value    = eventInfo.nFecha || '';
    byId('p_formacion').value = eventInfo.formacion || '';

    // ----- Estado de la planilla (se guarda/lee independiente) -----
    const STORAGE_KEY = 'cab_postpartido';
    const prev = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    // Resultado previo
    if (prev.res){
      byId('res_cab').value   = prev.res.res_cab ?? '';
      byId('res_rival').value = prev.res.res_rival ?? '';
    }

    // Otros comentarios
    if (prev.otrosComentarios){
      byId('otrosComentarios').value = prev.otrosComentarios;
    }

    // ----- Construcción de filas (titulares primero) -----
    const tbody = document.getElementById('tbody');
    const ordenados = [
      ...players.filter(p => p.position === 'titular'),
      ...players.filter(p => p.position !== 'titular')
    ];

    function filaJugador(p, idx){
      // Busco si ya había datos previos cargados para este número/nombre
      const key = p.number + '|' + p.name;
      const rowPrev = (prev.jugadores && prev.jugadores[key]) || {};

      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="center">${p.number || ''}</td>
        <td>${p.name || ''}</td>
        <td><input type="text" data-k="pos" value="${rowPrev.pos ?? ''}" placeholder="Ej: LI, 8, MCD"/></td>
        <td class="center"><input class="right" type="number" min="0" step="1" data-k="min" value="${rowPrev.min ?? ''}" placeholder="0"/></td>
        <td class="center"><input class="right" type="number" min="0" step="1" data-k="gol" value="${rowPrev.gol ?? ''}" placeholder="0"/></td>
        <td class="center"><input class="right" type="number" min="0" step="1" data-k="ast" value="${rowPrev.ast ?? ''}" placeholder="0"/></td>
        <td class="center"><input class="right" type="number" min="0" step="1" data-k="ta"  value="${rowPrev.ta  ?? ''}" placeholder="0"/></td>
        <td class="center"><input class="right" type="number" min="0" step="1" data-k="tr"  value="${rowPrev.tr  ?? ''}" placeholder="0"/></td>
        <td class="center"><input class="right" type="number" min="0" step="0.1" data-k="punt" value="${rowPrev.punt ?? ''}" placeholder="0"/></td>
        <td><input type="text" data-k="com" value="${rowPrev.com ?? ''}" placeholder="Comentario breve"/></td>
      `;

      // Guardamos claves para luego
      tr.dataset.key = key;
      return tr;
    }

    ordenados.forEach((p,i)=> tbody.appendChild(filaJugador(p,i)));

    // ----- Guardar planilla completa -----
    function getPlanilla(){
      const jugadores = {};
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const key = tr.dataset.key;
        const inputs = tr.querySelectorAll('input');
        const data = {};
        inputs.forEach(inp => {
          const k = inp.dataset.k;
          let val = inp.value;
          // números: convertimos si aplica
          if (['min','gol','ast','ta','tr','punt'].includes(k)){
            // permitir vacío -> null
            val = (val === '' ? null : Number(val));
          }
          data[k] = val;
        });
        jugadores[key] = data;
      });

      return {
        meta: {
          ts: Date.now(),
          categoria: eventInfo.categoria || '',
          rival: eventInfo.rival || '',
          condicion: eventInfo.condicion || '',
          predio: eventInfo.predio || '',
          fecha: eventInfo.fecha || '',
          hora: eventInfo.hora || '',
          nFecha: eventInfo.nFecha || '',
          formacion: eventInfo.formacion || ''
        },
        res: {
          res_cab: Number(byId('res_cab').value || 0),
          res_rival: Number(byId('res_rival').value || 0)
        },
        jugadores,
        otrosComentarios: byId('otrosComentarios').value || ''
      };
    }

    function guardar(){
      const data = getPlanilla();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      alert('Planilla guardada ✅');
    }

    // ----- Exportar CSV -----
    function exportCSV(){
      const data = getPlanilla();

      // Cabecera
      const headers = [
        'Numero','Jugador','Posicion','Minutos','Goles','Asistencias','TA','TR','Puntaje','Comentario'
      ];

      // Filas
      const rows = [headers];

      ordenados.forEach(p=>{
        const key = p.number + '|' + p.name;
        const r = (data.jugadores && data.jugadores[key]) || {};
        rows.push([
          p.number || '',
          p.name || '',
          r.pos ?? '',
          r.min ?? '',
          r.gol ?? '',
          r.ast ?? '',
          r.ta  ?? '',
          r.tr  ?? '',
          r.punt?? '',
          (r.com ?? '').replace(/\r?\n/g,' ').trim()
        ]);
      });

      // Metadatos al final (opcional)
      rows.push([]);
      rows.push(['Resultado', `${labCab.textContent} ${data.res.res_cab} - ${labRival.textContent} ${data.res.res_rival}`]);
      rows.push(['Categoria', data.meta.categoria]);
      rows.push(['Rival', data.meta.rival]);
      rows.push(['Condicion', data.meta.condicion]);
      rows.push(['Predio', data.meta.predio]);
      rows.push(['Fecha', data.meta.fecha]);
      rows.push(['Hora', data.meta.hora]);
      rows.push(['NFecha', data.meta.nFecha]);
      rows.push(['Formacion', data.meta.formacion]);
      rows.push([]);
      rows.push(['Otros comentarios', (data.otrosComentarios||'').replace(/\r?\n/g,' ').trim()]);

      const csv = rows.map(r => r.map(v=>{
        const s = String(v ?? '');
        // Envolver en comillas si contiene coma o comillas
        if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'planilla_post_partido.csv';
      a.click();
    }

    // ----- Auto-guardado cada 10s -----
    let autosaveTimer = setInterval(()=>{
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(getPlanilla()));
      }catch{}
    }, 10000);

    // ----- Botones -----
    document.getElementById('btnGuardar').addEventListener('click', guardar);
    document.getElementById('btnCSV').addEventListener('click', exportCSV);
    document.getElementById('btnVolver').addEventListener('click', ()=>{
      // Guardamos por si acaso
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(getPlanilla())); }catch{}
      location.href = 'index.html';
    });
  </script>
</body>
</html>
